<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>أذكار تفاعلية — مع عدّاد للتكرار</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e2e8f0;
      --muted: #94a3b8;
      --card: #111827;
      --accent: #22c55e;
      --accent-2: #3b82f6;
      --danger: #ef4444;
      --shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Naskh Arabic UI", "Amiri", "Tajawal", sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
    }
    header { padding: 16px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,0)); position: sticky; top: 0; z-index: 50; backdrop-filter: blur(6px); }
    h1 { margin: 0; font-size: 1.3rem; }
    .sub { color: var(--muted); font-size: .9rem; margin-top: 4px; }
    .controls { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
    button, .btn { background: #1f2937; color: var(--fg); border: 1px solid #334155; border-radius: 12px; padding: 10px 14px; cursor: pointer; box-shadow: var(--shadow); font-size: .95rem; }
    button:hover { filter: brightness(1.1); }
    .primary { background: var(--accent); border-color: #16a34a; color: #06220f; font-weight: 700; }
    .ghost { background: transparent; border-color: #334155; }
    .danger { background: var(--danger); border-color: #b91c1c; color: #fff; }
    .wrap { width: min(900px, 94vw); margin: 0 auto 32px; }
    .progress { background: #111827; border: 1px solid #334155; border-radius: 12px; overflow: hidden; height: 14px; margin-top: 8px; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .2s ease; }
    .stat { font-size: .9rem; color: var(--muted); margin-top: 6px; }
    .list { display: grid; gap: 10px; margin: 12px 0 24px; }
    .item { background: var(--card); border: 1px solid #334155; border-radius: 16px; padding: 14px; line-height: 2; font-size: 1.25rem; position: relative; cursor: pointer; transition: transform .05s ease; }
    .item:active { transform: scale(.995); }
    .item small { display: block; color: var(--muted); font-size: .85rem; }
    .item.done { opacity: .7; text-decoration: line-through; }
    .check { position: absolute; inset-inline-start: 10px; inset-block-start: 10px; width: 24px; height: 24px; border-radius: 999px; border: 2px solid #334155; display: grid; place-items: center; }
    .item.done .check { background: var(--accent); border-color: var(--accent); color: #052e1a; font-weight: 900; }
    .controls-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
    .counter { display: inline-flex; align-items: center; gap: 8px; background: #0b1220; border: 1px solid #334155; border-radius: 999px; padding: 6px 10px; font-size: .95rem; }
    .counter b { min-width: 2.5em; text-align: center; }
    .counter button { padding: 6px 10px; border-radius: 999px; }
    .note { color: var(--muted); font-size: .85rem; }
    .focus { display: none; margin-top: 12px; background: var(--card); border: 1px solid #334155; border-radius: 20px; padding: 18px; text-align: center; }
    .focus.active { display: block; }
    .focus .phrase { font-size: clamp(1.4rem, 3.8vw, 2.2rem); line-height: 2.1; margin: 10px 0 16px; }
    .focus .nav { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
    footer { color: var(--muted); text-align: center; padding: 16px; font-size: .85rem; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .spacer { flex: 1; }
    .hidden { display: none !important; }
    .fs { display:flex; gap:6px; align-items:center; }
    .fs input { width: 200px; }
    @media (prefers-color-scheme: light) { :root { --bg: #f8fafc; --fg: #0f172a; --muted: #475569; --card: #ffffff; } .item.done .check { color: #052e1a; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>أذكار تفاعلية — مع عدّاد للتكرار</h1>
      <div class="sub">أي ذكر فيه عدد (مثل: <em>(ثلاث مرات)</em> أو <em>(100 مرة)</em>) يظهر له <b>عدّاد</b>. كل نقرة تُنقص العدد، وعند الصفر يُعلَّم الذكر كمكتمل تلقائيًا.</div>
      <div class="controls">
        <button class="primary" id="toggleMode">وضع التركيز</button>
        <button class="ghost" id="shuffle">عشوائي</button>
        <button class="ghost" id="reset">إعادة التعيين</button>
        <button class="ghost" id="dark">سمة داكنة/فاتحة</button>
        <button class="ghost" id="wake">منع انطفاء الشاشة</button>
        <label class="btn ghost" for="importTxt">استيراد…<input id="importTxt" type="file" accept=".txt" hidden /></label>
        <button class="ghost" id="exportTxt">تصدير النص</button>
        <span class="fs">تكبير الخط: <input id="fontRange" type="range" min="16" max="40" value="24" /></span>
        <span class="spacer"></span>
        <small id="stamp" class="sub"></small>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="stat" id="stat">0% مكتمل — 0/0</div>
    </div>
  </header>

  <main class="wrap">
    <section id="list" class="list" aria-label="قائمة الأذكار"></section>

    <section id="focus" class="focus" aria-live="polite">
      <div class="row" style="justify-content:center; gap:12px; color:var(--muted)">
        <span id="idxInfo">0 / 0</span>
      </div>
      <div id="phrase" class="phrase">—</div>
      <div class="nav">
        <button id="prev">السابق ⟵</button>
        <button id="toggleDone" class="primary">تم ✓</button>
        <button id="next">⟶ التالي</button>
      </div>
      <div id="focusCounterWrap" class="controls-row"></div>
    </section>
  </main>

  <footer>يمكنك تعديل القائمة من داخل الملف (المتغير <code>DEFAULT_ADHKAR</code>) أو استيراد ملف نصي (سطر لكل جملة).</footer>

  <script>
    // ————— البيانات الافتراضية (مأخوذة مما أرسلتَ) —————
    const DEFAULT_ADHKAR = [
      "الم ۚ ذَلِكَ الْكِتَابُ لَا رَيْبَ فِيهِ هُدًى لِلْمُتَّقِينَ * الَّذِينَ يُؤْمِنُونَ بِالْغَيْبِ وَيُقِيمُونَ الصَّلَاةَ وَمِمَّا رَزَقْنَاهُمْ يُنْفِقُونَ * وَالَّذِينَ يُؤْمِنُونَ بِمَا أُنْزِلَ إِلَيْكَ وَمَا أُنْزِلَ مِنْ قَبْلِكَ وَبِالْآخِرَةِ هُمْ يُوقِنُونَ * أُولَئِكَ عَلَى هُدًى مِنْ رَبِّهِمْ وَأُولَئِكَ هُمُ الْمُفْلِحُونَ.",
      "اللَّهُ لَا إِلَٰهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضِ وَلَا يَئُودُهُ حِفْظُهُمَا وَهُوَ الْعَلِيُّ الْعَظِيمُ (البقرة:255).",
      "آمَنَ الرَّسُولُ بِمَا أُنْزِلَ إِلَيْهِ مِنْ رَبِّهِ وَالْمُؤْمِنُونَ كُلٌّ آمَنَ بِاللَّهِ وَمَلَائِكَتِهِ وَكُتُبِهِ وَرُسُلِهِ لَا نُفَرِّقُ بَيْنَ أَحَدٍ مِنْ رُسُلِهِ وَقَالُوا سَمِعْنَا وَأَطَعْنَا غُفْرَانَكَ رَبَّنَا وَإِلَيْكَ الْمَصِيرُ (285) لَا يُكَلِّفُ اللَّهُ نَفْسًا إِلَّا وُسْعَهَا لَهَا مَا كَسَبَتْ وَعَلَيْهَا مَا اكْتَسَبَتْ رَبَّنَا لَا تُؤَاخِذْنَا إِنْ نَسِينَا أَوْ أَخْطَأْنَا رَبَّنَا وَلَا تَحْمِلْ عَلَيْنَا إِصْرًا كَمَا حَمَلْتَهُ عَلَى الَّذِينَ مِنْ قَبْلِنَا رَبَّنَا وَلَا تُحَمِّلْنَا مَا لَا طَاقَةَ لَنَا بِهِ وَاعْفُ عَنَّا وَاغْفِرْ لَنَا وَارْحَمْنَا أَنْتَ مَوْلَانَا فَانْصُرْنَا عَلَى الْقَوْمِ الْكَافِرِينَ (286).",
      "حم * تَنْزِيلُ الْكِتَابِ مِنَ اللَّهِ الْعَزِيزِ الْعَلِيمِ * غَافِرِ الذَّنْبِ وَقَابِلِ التَّوْبِ شَدِيدِ الْعِقَابِ ذِي الطَّوْلِ لَا إِلَٰهَ إِلَّا هُوَ إِلَيْهِ الْمَصِيرُ (غافر 1–3).",
      "هُوَ اللَّهُ الَّذِي لَا إِلَٰهَ إِلَّا هُوَ عَالِمُ الْغَيْبِ وَالشَّهَادَةِ هُوَ الرَّحْمَٰنُ الرَّحِيمُ * هُوَ اللَّهُ الَّذِي لَا إِلَٰهَ إِلَّا هُوَ الْمَلِكُ الْقُدُّوسُ السَّلَامُ الْمُؤْمِنُ الْمُهَيْمِنُ الْعَزِيزُ الْجَبَّارُ الْمُتَكَبِّرُ سُبْحَانَ اللَّهِ عَمَّا يُشْرِكُونَ * هُوَ اللَّهُ الْخَالِقُ الْبَارِئُ الْمُصَوِّرُ لَهُ الْأَسْمَاءُ الْحُسْنَى يُسَبِّحُ لَهُ مَا فِي السَّمَاوَاتِ وَالْأَرْضِ وَهُوَ الْعَزِيزُ الْحَكِيمُ (الحشر 22–24).",
      "قُلْ هُوَ اللَّهُ أَحَدٌ * قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ * قُلْ أَعُوذُ بِرَبِّ النَّاسِ (ثلاث مرات).",
      "أعوذ بكلماتِ اللهِ التاماتِ من شرِّ ما خلق (ثلاث مرات).",
      "بسمِ اللهِ الذي لا يضرُّ معَ اسمِه شيءٌ في الأرضِ ولا في السماءِ وهو السميعُ العليمُ (ثلاث مرات).",
      "رضيتُ باللهِ ربًّا وبالإسلامِ دينًا وبمحمدٍ ﷺ نبيًّا (ثلاث مرات).",
      "أصبحنا وأصبح الملكُ لله والحمدُ لله، لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير… وفي المساء: أمسينا وأمسى الملك لله…",
      "اللهم بك أصبحنا وبك أمسينا وبك نحيا وبك نموت وإليك النشور. وفي المساء: اللهم بك أمسينا وبك أصبحنا وبك نموت وبك نحيا وإليك المصير.",
      "اللهم ما أصبحَ بي من نعمةٍ أو بأحدٍ من خلقك فمنك وحدك لا شريك لك، فلك الحمد ولك الشكر. وفي المساء يقول: ما أمسى بي…",
      "اللهم إني أصبحتُ في نعمةٍ وعافيةٍ وسِترٍ فأتمم نعمتك عليّ وعافيتك وسترك في الدنيا والآخرة (ثلاث مرات). وفي المساء: اللهم إني أمسيت…",
      "اللهم إني أعوذ بك من الهمِّ والحَزَن، وأعوذ بك من العجزِ والكسل، وأعوذ بك من الجبنِ والبخلِ والهرمِ وأن أُردَّ إلى أرذلِ العمر، وأعوذ بك من غلبةِ الدين وقهرِ الرجال، ومن الخرفِ والزهايمر ومن البرص والجنون والجذام وسوء الأسقام، ومن الطعن والطاعون، ومن شرِّ فيروس كورونا، ومن الغرقِ والهدمِ والحرق، ومن العينِ والسحرِ والحسد، ومن المخدراتِ والحوادث، ومن جميع فواجع الأقدار.",
      "اللهم إني أسألك العافية في الدنيا والآخرة، اللهم إني أسألك العفو والعافية في ديني ودنياي وأهلي ومالي، اللهم استر عورتي وآمن روعاتي، اللهم احفظني من بين يديّ ومن خلفي وعن يميني وعن شمالي ومن فوقي، وأعوذ بعظمتك أن أُغتال من تحتي.",
      "اللهم أنت ربي لا إله إلا أنت، خلقتني وأنا عبدك، وأنا على عهدك ووعدك ما استطعتُ، أعوذ بك من شر ما صنعت، أبوء لك بنعمتك عليّ، وأبوء بذنبي فاغفر لي فإنه لا يغفر الذنوب إلا أنت.",
      "اللهم فاطرَ السماواتِ والأرض، عالمَ الغيبِ والشهادة، ربَّ كل شيءٍ ومليكَه، أشهد أن لا إله إلا أنت، أعوذ بك من شرِّ نفسي ومن شرِّ الشيطانِ وشِرْكه، وأن أقترفَ على نفسي سوءًا أو أجرّه إلى مسلم.",
      "اللهم إني أصبحتُ أشهدك وأشهد حملةَ عرشك وملائكتك وأنبياءك وجميع خلقك بأنك أنت الله لا إله إلا أنت، وأن محمدًا عبدك ورسولك. وفي المساء: اللهم إني أمسيت… (أربع مرات).",
      "لا إله إلا الله وحده لا شريك له، له الملك وله الحمد وهو على كل شيء قدير (مائة مرة) صباحًا ومساءً.",
      "حسبيَ اللهُ لا إله إلا هو، عليه توكلتُ وهو ربُّ العرشِ العظيم (سبع مرات).",
      "حسبي الله وكفى، سمع الله لمن دعا، ليس وراء الله مرمى.",
      "سبحانَ اللهِ وبحمدِه (مائة مرة) صباحًا ومساءً أو فيهما جميعًا.",
      "أستغفرُ اللهَ وأتوبُ إليه (مائة مرة).",
      "اللهم إني أعوذ بك من تحول عافيتك، وزوال نعمتك، وفجأة نقمتك، وجميع سخطك (أربع مرات).",
      "اللهم عافني في بدني، اللهم عافني في سمعي، اللهم عافني في بصري، لا إله إلا أنت (ثلاث مرات).",
      "اللهم إني أعوذ بك من جهد البلاء، ودرك الشقاء، وسوء القضاء، وشماتة الأعداء (ثلاث مرات).",
      "سبحان الله وبحمده عدد خلقه ورضا نفسه وزنة عرشه ومداد كلماته (ثلاث مرات).",
      "أعوذُ بكلماتِ اللهِ التي لا يجاوزهن برٌّ ولا فاجرٌ من شر ما خلق وذرأ وبرأ، ومن شر ما يعرج في السماء وما ينزل منها، ومن شر ما ذرأ في الأرض وما يخرج منها، ومن شر إبليس وجنوده، ومن شر فتن الليل وفتن النهار، ومن شر طوارق الليل والنهار إلا طارقًا يطرق بخير.",
      "يا حيُّ يا قيومُ برحمتك أستغيث، أصلح لي شأني كلَّه، ولا تكلني إلى نفسي طرفةَ عينٍ ولا أقل من ذلك.",
      "أعوذُ بكلماتِ اللهِ التامة من كل شيطانٍ وهامَّة، ومن كل عينٍ لامَّة، ومن همزات الشياطين وأن يحضرون، ومن همزه ونفخه ونفثه (ثلاث مرات).",
      "أعوذُ بكلماتِ اللهِ التامات من شياطين الإنس والجن (ثلاث مرات).",
      "هذا ما تيسّر كتابتُه. أسألُ اللهَ تعالى أن ينفع به — من كلام الشيخ محمد بن صالح العثيمين رحمه الله (1418هـ)."
    ];

    // ————— مفاتيح التخزين —————
    const KEY_ITEMS = 'adhkar.items.v2';
    const KEY_DONE = 'adhkar.done.v2';
    const KEY_SETTINGS = 'adhkar.settings.v2';
    const KEY_COUNTS = 'adhkar.counts.v2'; // المتبقي لكل عنصر

    // ————— حالة التطبيق —————
    let items = load(KEY_ITEMS) || DEFAULT_ADHKAR;
    let done = load(KEY_DONE) || Array(items.length).fill(false);
    let settings = Object.assign({ fontSize: 24, dark: true, focus: false, index: 0 }, load(KEY_SETTINGS) || {});
    let counts = load(KEY_COUNTS) || initCountsFromItems(items);

    // ————— عناصر DOM —————
    const elList = document.getElementById('list');
    const elBar = document.getElementById('bar');
    const elStat = document.getElementById('stat');
    const elStamp = document.getElementById('stamp');
    const elFocus = document.getElementById('focus');
    const elPhrase = document.getElementById('phrase');
    const elIdxInfo = document.getElementById('idxInfo');
    const elFocusCounterWrap = document.getElementById('focusCounterWrap');

    // ————— تهيئة —————
    document.getElementById('fontRange').value = settings.fontSize;
    setBaseFont(settings.fontSize);
    if (!settings.dark) document.documentElement.classList.add('light');
    toggleFocus(settings.focus, true);
    render();

    // ————— إنشاء العناصر —————
    function render() {
      save(KEY_ITEMS, items);
      if (done.length !== items.length) done = Array(items.length).fill(false);
      if (counts.length !== items.length) counts = initCountsFromItems(items);
      save(KEY_DONE, done);
      save(KEY_COUNTS, counts);

      elList.innerHTML = '';
      items.forEach((text, i) => {
        const li = document.createElement('article');
        li.className = 'item' + (done[i] ? ' done' : '');
        li.setAttribute('tabindex', '0');
        li.dataset.index = i;
        li.innerHTML = `<div class="check">${done[i] ? '✓' : ''}</div><div>${escapeHTML(text)}</div>`;
        li.addEventListener('click', () => toggle(i));
        li.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(i); } });

        const rep = getRepetitionCount(text);
        if (rep && rep > 1) {
          const row = document.createElement('div');
          row.className = 'controls-row';
          const counter = makeCounter(i, rep);
          row.appendChild(counter);
          const note = document.createElement('span');
          note.className = 'note';
          note.textContent = 'عدّاد التكرار';
          row.appendChild(note);
          li.appendChild(row);
        }

        elList.appendChild(li);
      });

      const total = items.length;
      const count = done.filter(Boolean).length;
      const pct = total ? Math.round((count / total) * 100) : 0;
      elBar.style.width = pct + '%';
      elStat.textContent = `${pct}% مكتمل — ${count}/${total}`;
      elStamp.textContent = new Date().toLocaleString('ar-SA');

      if (settings.focus) updateFocus();
    }

    function toggle(idx) {
      done[idx] = !done[idx];
      if (done[idx]) counts[idx] = 0; // إذا اكتمل يدويًا، صفر العداد
      save(KEY_DONE, done);
      save(KEY_COUNTS, counts);
      try { navigator.vibrate && navigator.vibrate(15); } catch {}
      render();
    }

    function updateFocus() {
      const i = clamp(settings.index, 0, items.length - 1);
      settings.index = i;
      save(KEY_SETTINGS, settings);
      elPhrase.textContent = items[i] || '—';
      elIdxInfo.textContent = `${i + 1} / ${items.length}`;

      // تظليل العنصر الموافق
      [...document.querySelectorAll('.item')].forEach((node, idx) => {
        node.style.outline = idx === i ? '2px solid var(--accent-2)' : 'none';
      });

      // عدّاد وضع التركيز
      elFocusCounterWrap.innerHTML = '';
      const rep = getRepetitionCount(items[i]);
      if (rep && rep > 1) {
        elFocusCounterWrap.appendChild(makeCounter(i, rep));
      }
    }

    // ————— إنشاء عنصر عدّاد —————
    function makeCounter(index, rep) {
      const wrapper = document.createElement('div');
      wrapper.className = 'counter';
      // إذا كانت قيمة counts[index] غير معرفة، نهيئها بـ rep
      if (typeof counts[index] !== 'number' || counts[index] > rep || counts[index] < 0) counts[index] = rep;

      const btn = document.createElement('button');
      btn.className = 'ghost';
      btn.textContent = '− 1';
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (done[index]) return;
        counts[index] = Math.max(0, counts[index] - 1);
        if (counts[index] === 0) { done[index] = true; try { navigator.vibrate && navigator.vibrate([10,40,10]); } catch {} }
        save(KEY_DONE, done);
        save(KEY_COUNTS, counts);
        render();
      });

      const inc = document.createElement('button');
      inc.className = 'ghost';
      inc.textContent = '+ 1';
      inc.addEventListener('click', (e) => {
        e.stopPropagation();
        if (done[index]) return;
        counts[index] = Math.min(rep, counts[index] + 1);
        save(KEY_COUNTS, counts);
        render();
      });

      const reset = document.createElement('button');
      reset.className = 'ghost';
      reset.textContent = 'إعادة';
      reset.addEventListener('click', (e) => {
        e.stopPropagation();
        counts[index] = rep;
        done[index] = false;
        save(KEY_DONE, done);
        save(KEY_COUNTS, counts);
        render();
      });

      const num = document.createElement('b');
      num.textContent = counts[index] + ' / ' + rep;

      wrapper.appendChild(btn);
      wrapper.appendChild(num);
      wrapper.appendChild(inc);
      wrapper.appendChild(reset);
      return wrapper;
    }

    // ————— استخراج عدد التكرار من النص —————
    function getRepetitionCount(text) {
      // 1) أرقام عربية/إنجليزية داخل أقواس + كلمة "مرة/مرات"
      const numParens = /[\(（]\s*([0-9٠-٩]+)\s*مر(?:ة|ات)\s*[\)）]/i;
      const m1 = text.match(numParens);
      if (m1) return parseArabicDigits(m1[1]);

      // 2) كلمات شائعة
      const words = [
        ['مرتين', 2],
        ['ثلاث', 3], ['ثلاثة', 3],
        ['أربع', 4], ['أربعة', 4],
        ['خمس', 5], ['خمسة', 5],
        ['ست', 6], ['ستة', 6],
        ['سبع', 7], ['سبعة', 7],
        ['ثمان', 8], ['ثماني', 8], ['ثمانية', 8],
        ['تسع', 9], ['تسعة', 9],
        ['عشر', 10], ['عشرة', 10],
        ['إحدى عشرة', 11], ['إحدي عشرة', 11],
        ['اثنتا عشرة', 12], ['اثنا عشر', 12],
        ['مائة', 100], ['مئة', 100], ['مائه', 100]
      ];
      for (const [w, n] of words) {
        const re = new RegExp('\\((?:[^\\)]*' + w + '\\s+مر(?:ة|ات)[^\\)]*)\\)', 'i');
        if (re.test(text)) return n;
      }

      // 3) صيغة مثل (100 مرة) بدون أقواس العربية
      const plainNum = /([0-9٠-٩]+)\s*مر(?:ة|ات)/i;
      const m2 = text.match(plainNum);
      if (m2) return parseArabicDigits(m2[1]);

      return null;
    }

    function parseArabicDigits(str) {
      const map = {'٠':0,'١':1,'٢':2,'٣':3,'٤':4,'٥':5,'٦':6,'٧':7,'٨':8,'٩':9};
      return Number([...str].map(ch => ch in map ? map[ch] : ch).join(''));
    }

    function initCountsFromItems(arr) {
      return arr.map(t => {
        const r = getRepetitionCount(t);
        return r && r > 1 ? r : 0;
      });
    }

    // ————— أدوات مساعدة —————
    function save(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function escapeHTML(s) { return s.replace(/[&<>\\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\"':'&quot;'}[c])); }
    function setBaseFont(px) {
      document.getElementById('list').style.setProperty('--fs', px + 'px');
      document.querySelectorAll('.item').forEach(el => el.style.fontSize = px + 'px');
      document.getElementById('phrase').style.fontSize = Math.max(px + 2, 20) + 'px';
      save(KEY_SETTINGS, settings);
    }

    // ————— تحكم بالأزرار —————
    document.getElementById('toggleMode').onclick = () => toggleFocus(!settings.focus);
    document.getElementById('shuffle').onclick = () => { shuffle(items); save(KEY_ITEMS, items); render(); };
    document.getElementById('reset').onclick = () => {
      if (confirm('هل تريد تصفير التقدّم والعدادات؟')) {
        done = Array(items.length).fill(false);
        counts = initCountsFromItems(items);
        save(KEY_DONE, done);
        save(KEY_COUNTS, counts);
        settings.index = 0;
        render();
      }
    };
    document.getElementById('dark').onclick = () => {
      document.documentElement.classList.toggle('light');
      settings.dark = !document.documentElement.classList.contains('light');
      save(KEY_SETTINGS, settings);
    };
    document.getElementById('wake').onclick = toggleWakeLock;

    document.getElementById('prev').onclick = () => { settings.index = clamp(settings.index - 1, 0, items.length - 1); updateFocus(); };
    document.getElementById('next').onclick = () => { settings.index = clamp(settings.index + 1, 0, items.length - 1); updateFocus(); };
    document.getElementById('toggleDone').onclick = () => { toggle(settings.index); settings.index = clamp(settings.index + 1, 0, items.length - 1); updateFocus(); };
    document.getElementById('fontRange').oninput = (e) => { settings.fontSize = +e.target.value; setBaseFont(settings.fontSize); };

    // استيراد/تصدير
    document.getElementById('importTxt').addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      if (lines.length) {
        items = lines;
        done = Array(items.length).fill(false);
        counts = initCountsFromItems(items);
        settings.index = 0;
        save(KEY_ITEMS, items); save(KEY_DONE, done); save(KEY_COUNTS, counts);
        render();
      } else {
        alert('الملف لا يحتوي على أسطر صالحة.');
      }
    });
    document.getElementById('exportTxt').onclick = () => {
      const txt = items.join('\n');
      const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'adhkar.txt'; a.click();
      URL.revokeObjectURL(url);
    };

    // لوحة المفاتيح في وضع التركيز
    window.addEventListener('keydown', (e) => {
      if (!settings.focus) return;
      if (['Space', 'Enter'].includes(e.code)) { e.preventDefault(); document.getElementById('toggleDone').click(); }
      else if (e.code === 'ArrowRight' || e.code === 'ArrowLeft') { e.preventDefault(); (e.code === 'ArrowRight' ? next : prev)(); }
    });
    function next(){ document.getElementById('next').click(); }
    function prev(){ document.getElementById('prev').click(); }

    // تبديل وضع التركيز
    function toggleFocus(on, firstRun=false) {
      settings.focus = on; save(KEY_SETTINGS, settings);
      document.getElementById('toggleMode').textContent = on ? 'وضع القائمة' : 'وضع التركيز';
      elFocus.classList.toggle('active', on);
      document.getElementById('list').classList.toggle('hidden', on);
      if (on) updateFocus();
      if (!firstRun) try { navigator.vibrate && navigator.vibrate(10); } catch {}
    }

    // خلط
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Wake Lock
    let wakeLockSentinel = null;
    async function toggleWakeLock(){
      try {
        if (wakeLockSentinel) { await wakeLockSentinel.release(); wakeLockSentinel = null; alert('تم إيقاف منع الانطفاء.'); return; }
        if ('wakeLock' in navigator) {
          wakeLockSentinel = await navigator.wakeLock.request('screen');
          wakeLockSentinel.addEventListener('release', () => wakeLockSentinel = null);
          alert('تم تفعيل منع انطفاء الشاشة.');
        } else {
          alert('متصفحك لا يدعم هذه الميزة.');
        }
      } catch(err){ alert('تعذّر تفعيل الميزة: ' + err.message); }
    }
  </script>
</body>
</html>
